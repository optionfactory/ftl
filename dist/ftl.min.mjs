function t(e,r,n,a){var o=Error.call(this,e);return Object.setPrototypeOf&&Object.setPrototypeOf(o,t.prototype),o.expected=r,o.found=n,o.location=a,o.name="SyntaxError",o}function e(t,e,r){return r=r||" ",t.length>e?t:(e-=t.length,t+(r+=r.repeat(e)).slice(0,e))}function r(e,r){var n,a,o,l,u={},c=(r=void 0!==r?r:{}).grammarSource,i={Root:ft},s=ft,h=":",f="?.",d=",",p="true",v="false",m=/^[0-9]/,A=/^[^']/,g=/^[^"]/,C=/^[a-zA-Z$_]/,y=/^[a-zA-Z$_0-9_]/,x=/^[ \t\n\r]/,T=lt("?",!1),E=lt(":",!1),F=lt("?.",!1),N=lt(".",!1),b=ct("subscript"),w=lt("[",!1),S=lt("]",!1),H=ct("methodCall"),R=lt("(",!1),j=lt(",",!1),O=lt(")",!1),M=ct("functionCall"),_=ct("boolean"),L=lt("true",!1),P=lt("false",!1),D=ct("number"),I=ut([["0","9"]],!1,!1),k=ct("string"),V=lt("'",!1),W=ut(["'"],!0,!1),X=lt('"',!1),Z=ut(['"'],!0,!1),$=ct("array"),z=ct("dict"),q=lt("{",!1),U=lt("}",!1),B=ct("function-ref"),J=lt("#",!1),K=ut([["a","z"],["A","Z"],"$","_"],!1,!1),G=ut([["a","z"],["A","Z"],"$","_",["0","9"],"_"],!1,!1),Q=ct("symbol"),Y=ct("whitespaces"),tt=ut([" ","\t","\n","\r"],!1,!1),et=0,rt=[{line:1,column:1}],nt=0,at=[],ot=0;if("startRule"in r){if(!(r.startRule in i))throw new Error("Can't start parsing from rule \""+r.startRule+'".');s=i[r.startRule]}function lt(t,e){return{type:"literal",text:t,ignoreCase:e}}function ut(t,e,r){return{type:"class",parts:t,inverted:e,ignoreCase:r}}function ct(t){return{type:"other",description:t}}function it(t){var r,n=rt[t];if(n)return n;for(r=t-1;!rt[r];)r--;for(n={line:(n=rt[r]).line,column:n.column};r<t;)10===e.charCodeAt(r)?(n.line++,n.column=1):n.column++,r++;return rt[t]=n,n}function st(t,e){var r=it(t),n=it(e);return{source:c,start:{offset:t,line:r.line,column:r.column},end:{offset:e,line:n.line,column:n.column}}}function ht(t){et<nt||(et>nt&&(nt=et,at=[]),at.push(t))}function ft(){var t,e;return t=et,xt(),(e=dt())!==u?(xt(),t=e):(et=t,t=u),t}function dt(){var t,r,n,a,o,l,c;if(t=et,r=function(){var t;t=function(){var t,r,n,a,o,l,c,i;if(ot++,t=et,r=function(){var t,r,n,a,o,l;ot++,t=et,35===e.charCodeAt(et)?(r="#",et++):(r=u,0===ot&&ht(J));if(r!==u){if(n=[],a=et,o=[],C.test(e.charAt(et))?(l=e.charAt(et),et++):(l=u,0===ot&&ht(K)),l!==u)for(;l!==u;)o.push(l),C.test(e.charAt(et))?(l=e.charAt(et),et++):(l=u,0===ot&&ht(K));else o=u;for(o!==u?(58===e.charCodeAt(et)?(l=h,et++):(l=u,0===ot&&ht(E)),l!==u?a=o:(et=a,a=u)):(et=a,a=u);a!==u;){if(n.push(a),a=et,o=[],C.test(e.charAt(et))?(l=e.charAt(et),et++):(l=u,0===ot&&ht(K)),l!==u)for(;l!==u;)o.push(l),C.test(e.charAt(et))?(l=e.charAt(et),et++):(l=u,0===ot&&ht(K));else o=u;o!==u?(58===e.charCodeAt(et)?(l=h,et++):(l=u,0===ot&&ht(E)),l!==u?a=o:(et=a,a=u)):(et=a,a=u)}if(C.test(e.charAt(et))?(a=e.charAt(et),et++):(a=u,0===ot&&ht(K)),a!==u){for(o=[],y.test(e.charAt(et))?(l=e.charAt(et),et++):(l=u,0===ot&&ht(G));l!==u;)o.push(l),y.test(e.charAt(et))?(l=e.charAt(et),et++):(l=u,0===ot&&ht(G));c=a,i=o,t={type:"function",module:n.map((t=>t.join(""))),value:c+i.join("")}}else et=t,t=u}else et=t,t=u;var c,i;ot--,t===u&&(r=u,0===ot&&ht(B));return t}(),r!==u)if(40===e.charCodeAt(et)?(n="(",et++):(n=u,0===ot&&ht(R)),n!==u){for(xt(),a=et,(o=dt())!==u?(l=xt(),a=o):(et=a,a=u),a===u&&(a=null),o=[],l=et,44===e.charCodeAt(et)?(c=d,et++):(c=u,0===ot&&ht(j)),c!==u?(xt(),(i=dt())!==u?(xt(),l=i):(et=l,l=u)):(et=l,l=u);l!==u;)o.push(l),l=et,44===e.charCodeAt(et)?(c=d,et++):(c=u,0===ot&&ht(j)),c!==u?(xt(),(i=dt())!==u?(xt(),l=i):(et=l,l=u)):(et=l,l=u);41===e.charCodeAt(et)?(l=")",et++):(l=u,0===ot&&ht(O)),l!==u?(f=o,t={type:"call",value:r,args:null==(s=a)?[]:[s].concat(f)}):(et=t,t=u)}else et=t,t=u;else et=t,t=u;var s,f;ot--,t===u&&(r=u,0===ot&&ht(M));return t}(),t===u&&(t=function(){var t;t=function(){var t,r,n,a,o,l;ot++,t=et,r=[],m.test(e.charAt(et))?(n=e.charAt(et),et++):(n=u,0===ot&&ht(I));if(n!==u)for(;n!==u;)r.push(n),m.test(e.charAt(et))?(n=e.charAt(et),et++):(n=u,0===ot&&ht(I));else r=u;if(r!==u){if(n=et,46===e.charCodeAt(et)?(a=".",et++):(a=u,0===ot&&ht(N)),a!==u){for(o=[],m.test(e.charAt(et))?(l=e.charAt(et),et++):(l=u,0===ot&&ht(I));l!==u;)o.push(l),m.test(e.charAt(et))?(l=e.charAt(et),et++):(l=u,0===ot&&ht(I));n=o}else et=n,n=u;n===u&&(n=null),c=r,t=null==(i=n)?{type:"literal",value:parseInt(c.join(""))}:{type:"literal",value:parseFloat(c.join("")+"."+i.join(""))}}else et=t,t=u;var c,i;ot--,t===u&&(r=u,0===ot&&ht(D));return t}(),t===u&&(t=function(){var t,r;ot++,t=et,e.substr(et,4)===p?(r=p,et+=4):(r=u,0===ot&&ht(L));r!==u&&(r={type:"literal",value:!0});(t=r)===u&&(t=et,e.substr(et,5)===v?(r=v,et+=5):(r=u,0===ot&&ht(P)),r!==u&&(r={type:"literal",value:!1}),t=r);ot--,t===u&&(r=u,0===ot&&ht(_));return t}(),t===u&&(t=Ct())===u&&(t=function(){var t,r,n,a,o,l,c;ot++,t=et,91===e.charCodeAt(et)?(r="[",et++):(r=u,0===ot&&ht(w));if(r!==u){for(xt(),(n=dt())===u&&(n=null),xt(),a=[],o=et,44===e.charCodeAt(et)?(l=d,et++):(l=u,0===ot&&ht(j)),l!==u?(xt(),(c=dt())!==u?(xt(),o=c):(et=o,o=u)):(et=o,o=u);o!==u;)a.push(o),o=et,44===e.charCodeAt(et)?(l=d,et++):(l=u,0===ot&&ht(j)),l!==u?(xt(),(c=dt())!==u?(xt(),o=c):(et=o,o=u)):(et=o,o=u);93===e.charCodeAt(et)?(o="]",et++):(o=u,0===ot&&ht(S)),o!==u?(s=a,t={type:"array",value:null==(i=n)?[]:[i].concat(s)}):(et=t,t=u)}else et=t,t=u;var i,s;ot--,t===u&&(r=u,0===ot&&ht($));return t}(),t===u&&(t=function(){var t,r,n,a,o,l,c,i,s,f,p;ot++,t=et,123===e.charCodeAt(et)?(r="{",et++):(r=u,0===ot&&ht(q));if(r!==u){for(xt(),n=et,(a=Ct())!==u?(o=xt(),58===e.charCodeAt(et)?(l=h,et++):(l=u,0===ot&&ht(E)),l!==u?(c=xt(),(i=dt())!==u?n=[a,i]:(et=n,n=u)):(et=n,n=u)):(et=n,n=u),n===u&&(n=null),a=xt(),o=[],l=et,44===e.charCodeAt(et)?(c=d,et++):(c=u,0===ot&&ht(j)),c!==u?(i=xt(),(s=Ct())!==u?(xt(),58===e.charCodeAt(et)?(f=h,et++):(f=u,0===ot&&ht(E)),f!==u?(xt(),(p=dt())!==u?(xt(),l=[s,p]):(et=l,l=u)):(et=l,l=u)):(et=l,l=u)):(et=l,l=u);l!==u;)o.push(l),l=et,44===e.charCodeAt(et)?(c=d,et++):(c=u,0===ot&&ht(j)),c!==u?(i=xt(),(s=Ct())!==u?(xt(),58===e.charCodeAt(et)?(f=h,et++):(f=u,0===ot&&ht(E)),f!==u?(xt(),(p=dt())!==u?(xt(),l=[s,p]):(et=l,l=u)):(et=l,l=u)):(et=l,l=u)):(et=l,l=u);125===e.charCodeAt(et)?(l="}",et++):(l=u,0===ot&&ht(U)),l!==u?(m=o,A=[],null!==(v=n)&&A.push(v),A.push.apply(A,m),t={type:"dict",value:A}):(et=t,t=u)}else et=t,t=u;var v,m,A;ot--,t===u&&(r=u,0===ot&&ht(z));return t}(),t===u&&(t=Ct()))));return t}(),t===u&&(t=yt()));return t}(),r!==u){for(xt(),n=[],a=et,(o=pt())===u&&(o=vt())===u&&(o=mt())===u&&(o=At())===u&&(o=gt()),o!==u?(xt(),a=o):(et=a,a=u);a!==u;)n.push(a),a=et,(o=pt())===u&&(o=vt())===u&&(o=mt())===u&&(o=At())===u&&(o=gt()),o!==u?(xt(),a=o):(et=a,a=u);l=r,t=0===(c=n).length?l:{type:"nav",from:l,to:c}}else et=t,t=u;return t}function pt(){var t,r,n,a,o;return t=et,63===e.charCodeAt(et)?(r="?",et++):(r=u,0===ot&&ht(T)),r!==u?(xt(),(n=dt())===u&&(n=null),xt(),58===e.charCodeAt(et)?(a=h,et++):(a=u,0===ot&&ht(E)),a!==u?(xt(),(o=dt())!==u?t={type:"cond",ifTrue:n,ifFalse:o}:(et=t,t=u)):(et=t,t=u)):(et=t,t=u),t}function vt(){var t,r,n;return t=et,e.substr(et,2)===f?(r=f,et+=2):(r=u,0===ot&&ht(F)),r!==u?(xt(),(n=yt())!==u?t={type:"dot",ns:!0,value:n.value}:(et=t,t=u)):(et=t,t=u),t}function mt(){var t,r,n;return t=et,46===e.charCodeAt(et)?(r=".",et++):(r=u,0===ot&&ht(N)),r!==u?(xt(),(n=yt())!==u?t={type:"dot",ns:!1,value:n.value}:(et=t,t=u)):(et=t,t=u),t}function At(){var t,r,n,a,o;return ot++,t=et,e.substr(et,2)===f?(r=f,et+=2):(r=u,0===ot&&ht(F)),r===u&&(r=null),91===e.charCodeAt(et)?(n="[",et++):(n=u,0===ot&&ht(w)),n!==u?(xt(),(a=dt())!==u?(xt(),93===e.charCodeAt(et)?(o="]",et++):(o=u,0===ot&&ht(S)),o!==u?t={type:"sub",ns:null!==r,value:a}:(et=t,t=u)):(et=t,t=u)):(et=t,t=u),ot--,t===u&&(r=u,0===ot&&ht(b)),t}function gt(){var t,r,n,a,o,l,c,i,s,h;if(ot++,t=et,e.substr(et,2)===f?(r=f,et+=2):(r=u,0===ot&&ht(F)),r===u&&(r=null),40===e.charCodeAt(et)?(n="(",et++):(n=u,0===ot&&ht(R)),n!==u){for(xt(),a=et,(o=dt())!==u?(l=xt(),a=o):(et=a,a=u),a===u&&(a=null),o=[],l=et,44===e.charCodeAt(et)?(c=d,et++):(c=u,0===ot&&ht(j)),c!==u?(xt(),(i=dt())!==u?(xt(),l=i):(et=l,l=u)):(et=l,l=u);l!==u;)o.push(l),l=et,44===e.charCodeAt(et)?(c=d,et++):(c=u,0===ot&&ht(j)),c!==u?(xt(),(i=dt())!==u?(xt(),l=i):(et=l,l=u)):(et=l,l=u);41===e.charCodeAt(et)?(l=")",et++):(l=u,0===ot&&ht(O)),l!==u?(h=o,t={type:"method",ns:null!==r,value:null==(s=a)?[]:[s].concat(h)}):(et=t,t=u)}else et=t,t=u;return ot--,t===u&&(r=u,0===ot&&ht(H)),t}function Ct(){var t,r,n,a;if(ot++,t=et,39===e.charCodeAt(et)?(r="'",et++):(r=u,0===ot&&ht(V)),r!==u){for(n=[],A.test(e.charAt(et))?(a=e.charAt(et),et++):(a=u,0===ot&&ht(W));a!==u;)n.push(a),A.test(e.charAt(et))?(a=e.charAt(et),et++):(a=u,0===ot&&ht(W));39===e.charCodeAt(et)?(a="'",et++):(a=u,0===ot&&ht(V)),a!==u?t=function(t){return{type:"literal",value:t.join("")}}(n):(et=t,t=u)}else et=t,t=u;if(t===u)if(t=et,34===e.charCodeAt(et)?(r='"',et++):(r=u,0===ot&&ht(X)),r!==u){for(n=[],g.test(e.charAt(et))?(a=e.charAt(et),et++):(a=u,0===ot&&ht(Z));a!==u;)n.push(a),g.test(e.charAt(et))?(a=e.charAt(et),et++):(a=u,0===ot&&ht(Z));34===e.charCodeAt(et)?(a='"',et++):(a=u,0===ot&&ht(X)),a!==u?t={type:"literal",value:v1.join("")}:(et=t,t=u)}else et=t,t=u;return ot--,t===u&&(r=u,0===ot&&ht(k)),t}function yt(){var t,r,n,a;if(ot++,t=et,C.test(e.charAt(et))?(r=e.charAt(et),et++):(r=u,0===ot&&ht(K)),r!==u){for(n=[],y.test(e.charAt(et))?(a=e.charAt(et),et++):(a=u,0===ot&&ht(G));a!==u;)n.push(a),y.test(e.charAt(et))?(a=e.charAt(et),et++):(a=u,0===ot&&ht(G));t={type:"symbol",value:r+n.join("")}}else et=t,t=u;return ot--,t===u&&(r=u,0===ot&&ht(Q)),t}function xt(){var t,r;for(ot++,t=[],x.test(e.charAt(et))?(r=e.charAt(et),et++):(r=u,0===ot&&ht(tt));r!==u;)t.push(r),x.test(e.charAt(et))?(r=e.charAt(et),et++):(r=u,0===ot&&ht(tt));return ot--,r=u,0===ot&&ht(Y),t}if((n=s())!==u&&et===e.length)return n;throw n!==u&&et<e.length&&ht({type:"end"}),a=at,o=nt<e.length?e.charAt(nt):null,l=nt<e.length?st(nt,nt+1):st(nt,nt),new t(t.buildMessage(a,o),a,o,l)}function n(t,e,r,a){var o=Error.call(this,t);return Object.setPrototypeOf&&Object.setPrototypeOf(o,n.prototype),o.expected=e,o.found=r,o.location=a,o.name="SyntaxError",o}function a(t,e,r){return r=r||" ",t.length>e?t:(e-=t.length,t+(r+=r.repeat(e)).slice(0,e))}function o(t,e){var r,a,o,l,u={},c=(e=void 0!==e?e:{}).grammarSource,i={Root:L},s=L,h="{{{",f="}}}",d="{{",p="}}",v="{",m="}",A=/^[^{}]/,g=j("{{{",!1),C=j("}}}",!1),y=j("{{",!1),x=j("}}",!1),T={type:"class",parts:["{","}"],inverted:!0,ignoreCase:!1},E=j("{",!1),F=j("}",!1),N=j("\\",!1),b=0,w=[{line:1,column:1}],S=0,H=[],R=0;if("startRule"in e){if(!(e.startRule in i))throw new Error("Can't start parsing from rule \""+e.startRule+'".');s=i[e.startRule]}function j(t,e){return{type:"literal",text:t,ignoreCase:e}}function O(e){var r,n=w[e];if(n)return n;for(r=e-1;!w[r];)r--;for(n={line:(n=w[r]).line,column:n.column};r<e;)10===t.charCodeAt(r)?(n.line++,n.column=1):n.column++,r++;return w[e]=n,n}function M(t,e){var r=O(t),n=O(e);return{source:c,start:{offset:t,line:r.line,column:r.column},end:{offset:e,line:n.line,column:n.column}}}function _(t){b<S||(b>S&&(S=b,H=[]),H.push(t))}function L(){var t,e;for(t=[],e=P();e!==u;)t.push(e),e=P();return t}function P(){var e,r,n,a,o;return e=b,r=b,n=function(){var e;t.substr(b,3)===h?(e=h,b+=3):(e=u,0===R&&_(g));return e}(),n!==u&&(a=D())!==u?(o=function(){var e;t.substr(b,3)===f?(e=f,b+=3):(e=u,0===R&&_(C));return e}(),o!==u?r=a:(b=r,r=u)):(b=r,r=u),r!==u&&(r={t:"he",v:r}),(e=r)===u&&(e=b,r=b,n=function(){var e;t.substr(b,2)===d?(e=d,b+=2):(e=u,0===R&&_(y));return e}(),n!==u&&(a=D())!==u?(o=function(){var e;t.substr(b,2)===p?(e=p,b+=2):(e=u,0===R&&_(x));return e}(),o!==u?r=a:(b=r,r=u)):(b=r,r=u),r!==u&&(r=function(t){return{t:"te",v:t}}(r)),(e=r)===u&&(e=b,(r=D())!==u&&(r=function(t){return{t:"t",v:t}}(r)),e=r)),e}function D(){var e,r,n,a,o;if(b,e=[],(r=I())===u&&(r=k())===u&&(r=b,A.test(t.charAt(b))?(n=t.charAt(b),b++):(n=u,0===R&&_(T)),n!==u?r=n:(b=r,r=u),r===u&&(r=b,123===t.charCodeAt(b)?(n=v,b++):(n=u,0===R&&_(E)),n!==u?(a=b,R++,123===t.charCodeAt(b)?(o=v,b++):(o=u,0===R&&_(E)),R--,o===u?a=void 0:(b=a,a=u),a!==u?r=n:(b=r,r=u)):(b=r,r=u),r===u&&(r=b,125===t.charCodeAt(b)?(n=m,b++):(n=u,0===R&&_(F)),n!==u?(a=b,R++,125===t.charCodeAt(b)?(o=m,b++):(o=u,0===R&&_(F)),R--,o===u?a=void 0:(b=a,a=u),a!==u?r=n:(b=r,r=u)):(b=r,r=u)))),r!==u)for(;r!==u;)e.push(r),(r=I())===u&&(r=k())===u&&(r=b,A.test(t.charAt(b))?(n=t.charAt(b),b++):(n=u,0===R&&_(T)),n!==u?r=n:(b=r,r=u),r===u&&(r=b,123===t.charCodeAt(b)?(n=v,b++):(n=u,0===R&&_(E)),n!==u?(a=b,R++,123===t.charCodeAt(b)?(o=v,b++):(o=u,0===R&&_(E)),R--,o===u?a=void 0:(b=a,a=u),a!==u?r=n:(b=r,r=u)):(b=r,r=u),r===u&&(r=b,125===t.charCodeAt(b)?(n=m,b++):(n=u,0===R&&_(F)),n!==u?(a=b,R++,125===t.charCodeAt(b)?(o=m,b++):(o=u,0===R&&_(F)),R--,o===u?a=void 0:(b=a,a=u),a!==u?r=n:(b=r,r=u)):(b=r,r=u))));else e=u;return e!==u&&(e=e.join("")),e}function I(){var e,r,n;return e=b,92===t.charCodeAt(b)?(r="\\",b++):(r=u,0===R&&_(N)),r!==u?(123===t.charCodeAt(b)?(n=v,b++):(n=u,0===R&&_(E)),n!==u?e=n:(b=e,e=u)):(b=e,e=u),e}function k(){var e,r,n;return e=b,92===t.charCodeAt(b)?(r="\\",b++):(r=u,0===R&&_(N)),r!==u?(125===t.charCodeAt(b)?(n=m,b++):(n=u,0===R&&_(F)),n!==u?e=n:(b=e,e=u)):(b=e,e=u),e}if((r=s())!==u&&b===t.length)return r;throw r!==u&&b<t.length&&_({type:"end"}),a=H,o=S<t.length?t.charAt(S):null,l=S<t.length?M(S,S+1):M(S,S),new n(n.buildMessage(a,o),a,o,l)}!function(t,e){function r(){this.constructor=t}r.prototype=e.prototype,t.prototype=new r}(t,Error),t.prototype.format=function(t){var r="Error: "+this.message;if(this.location){var n,a=null;for(n=0;n<t.length;n++)if(t[n].source===this.location.source){a=t[n].text.split(/\r\n|\n|\r/g);break}var o=this.location.start,l=this.location.source+":"+o.line+":"+o.column;if(a){var u=this.location.end,c=e("",o.line.toString().length," "),i=a[o.line-1],s=(o.line===u.line?u.column:i.length+1)-o.column||1;r+="\n --\x3e "+l+"\n"+c+" |\n"+o.line+" | "+i+"\n"+c+" | "+e("",o.column-1," ")+e("",s,"^")}else r+="\n at "+l}return r},t.buildMessage=function(t,e){var r={literal:function(t){return'"'+a(t.text)+'"'},class:function(t){var e=t.parts.map((function(t){return Array.isArray(t)?o(t[0])+"-"+o(t[1]):o(t)}));return"["+(t.inverted?"^":"")+e.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(t){return t.description}};function n(t){return t.charCodeAt(0).toString(16).toUpperCase()}function a(t){return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(t){return"\\x0"+n(t)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(t){return"\\x"+n(t)}))}function o(t){return t.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(t){return"\\x0"+n(t)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(t){return"\\x"+n(t)}))}function l(t){return r[t.type](t)}return"Expected "+function(t){var e,r,n=t.map(l);if(n.sort(),n.length>0){for(e=1,r=1;e<n.length;e++)n[e-1]!==n[e]&&(n[r]=n[e],r++);n.length=r}switch(n.length){case 1:return n[0];case 2:return n[0]+" or "+n[1];default:return n.slice(0,-1).join(", ")+", or "+n[n.length-1]}}(t)+" but "+function(t){return t?'"'+a(t)+'"':"end of input"}(e)+" found."},function(t,e){function r(){this.constructor=t}r.prototype=e.prototype,t.prototype=new r}(n,Error),n.prototype.format=function(t){var e="Error: "+this.message;if(this.location){var r,n=null;for(r=0;r<t.length;r++)if(t[r].source===this.location.source){n=t[r].text.split(/\r\n|\n|\r/g);break}var o=this.location.start,l=this.location.source+":"+o.line+":"+o.column;if(n){var u=this.location.end,c=a("",o.line.toString().length," "),i=n[o.line-1],s=(o.line===u.line?u.column:i.length+1)-o.column||1;e+="\n --\x3e "+l+"\n"+c+" |\n"+o.line+" | "+i+"\n"+c+" | "+a("",o.column-1," ")+a("",s,"^")}else e+="\n at "+l}return e},n.buildMessage=function(t,e){var r={literal:function(t){return'"'+a(t.text)+'"'},class:function(t){var e=t.parts.map((function(t){return Array.isArray(t)?o(t[0])+"-"+o(t[1]):o(t)}));return"["+(t.inverted?"^":"")+e.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(t){return t.description}};function n(t){return t.charCodeAt(0).toString(16).toUpperCase()}function a(t){return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(t){return"\\x0"+n(t)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(t){return"\\x"+n(t)}))}function o(t){return t.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(t){return"\\x0"+n(t)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(t){return"\\x"+n(t)}))}function l(t){return r[t.type](t)}return"Expected "+function(t){var e,r,n=t.map(l);if(n.sort(),n.length>0){for(e=1,r=1;e<n.length;e++)n[e-1]!==n[e]&&(n[r]=n[e],r++);n.length=r}switch(n.length){case 1:return n[0];case 2:return n[0]+" or "+n[1];default:return n.slice(0,-1).join(", ")+", or "+n[n.length-1]}}(t)+" but "+function(t){return t?'"'+a(t)+'"':"end of input"}(e)+" found."};class l{constructor(t,e){this.dataStack=t,this.functions=e}call(t){const e=t.value,r=e.module.reduce(((t,e)=>t[e]),this.functions),n=t.args.map((t=>this.visit(t)));return r[e.value].apply(this,n)}nav(t){const e=[this.visit(t.from)];for(let r=0;r!==t.to.length;++r){const n=this.visit(t.to[r],e[r],e[r-1]);if(0===n.length)return e[e.length-1];e.push(n[0])}return e[e.length-1]}literal(t){return t.value}symbol(t){if("self"===t.value)return this.dataStack[this.dataStack.length-1];for(let e=this.dataStack.length;0!==e;--e){const r=this.dataStack[e-1];if(r.hasOwnProperty(t.value))return r[t.value]}}dict(t){return t.value.map((t=>[t[0].value,this.visit(t[1])]))}array(t){return t.value.map((t=>this.visit(t)))}cond(t,e){return[e?null===t.ifTrue?e:this.visit(t.ifTrue):this.visit(t.ifFalse)]}dot(t,e){return t.ns&&null==e?[]:[e[t.value]]}sub(t,e){return t.ns&&null==e?[]:[e[this.visit(t.value)]]}method(t,e,r){if(t.ns&&null==e)return[];const n=t.value.map((t=>this.visit(t)));return[e.apply(r,n)]}visit(t,...e){return this[t.type](t,...e)}}class u{constructor(t){this.functions=t||{}}parse(t){return r(t)}evaluateAst(t,e){return new l(e,this.functions).visit(t)}evaluate(t,...e){return this.evaluateAst(this.parse(t),e)}}class c{constructor(t){this.evaluator=t}parse(t){return o(t).map((t=>"t"===t.t?t:{t:t.t,v:this.evaluator.parse(t.v)}))}evaluateAst(t,e){return t.map((t=>"t"===t.t?t:{t:"te"===t.t?"t":"h",v:this.evaluator.evaluateAst(t.v,e)}))}evaluate(t,...e){return this.evaluateAst(this.parse(t),e)}}const i={fragmentFromNodes(t,e,...r){const n=new DocumentFragment;for(let a=0;a!==r.length;++a){const o=r[a],l=e&&o instanceof HTMLTemplateElement?o.content:o;n.appendChild(t?l.cloneNode(!0):o)}return n},fragmentFromHtml(...t){const e=document.createElement("div");return e.innerHTML=t.join(""),i.fragmentFromNodes(!1,!1,...e.childNodes)},html(...t){var e=document.createElement("root");return e.appendChild(i.fragmentFromNodes(!0,!1,...t)),e.innerHTML},addSuccessors(t,e){const r=Array.from(e);let n=t.nextSibling;for(let e=0;e!==r.length;++e){const a=r[e],o=a instanceof DocumentFragment?a.lastChild:a;t.parentNode.insertBefore(a,n),n=o?.nextSibling}}};class s{constructor(t){this.prefix=t,this.forRemoval=[]}remove(t){"innerHTML"in t&&(t.innerHTML=""),"dataset"in t&&Object.keys(t.dataset).filter((t=>t.startsWith(this.prefix))).forEach((e=>delete t.dataset[e])),this.forRemoval.push(t)}popData(t,e){const r=t.dataset[e];return delete t.dataset[e],r}replace(t,e){i.addSuccessors(t,e),this.remove(t)}cleanup(){for(;this.forRemoval.length;)this.forRemoval.pop().remove()}}class h{static DATA_PREFIX="tpl";static COMMANDS=["tplIf","tplWith","tplEach","tplValue","tplClassAppend","tplAttrAppend","tplText","tplHtml","tplRemove"];dataPrefix(){return h.DATA_PREFIX}orderedCommands(){return h.COMMANDS}tplIf(t,e,r,n,...a){t.evaluator.evaluate(r,...a)||n.remove(e)}tplWith(t,e,r,n,...a){const o=t.evaluator.evaluate(r,...a),l=n.popData(e,h.DATA_PREFIX+"Var"),u=t.withNode(e).render(...a,l?{[l]:o}:o);n.replace(e,[u])}tplEach(t,e,r,n,...a){const o=n.popData(e,h.DATA_PREFIX+"Var"),l=t.evaluator.evaluate(r,...a).map((r=>t.withNode(e).render(...a,o?{[o]:r}:r)));n.replace(e,l)}tplRemove(t,e,r,n,...a){switch(r.toLowerCase()){case"tag":n.replace(e,e.childNodes);break;case"body":e.innerHTML="";break;case"all":n.remove(e)}}tplText(t,e,r,n,...a){const o=t.evaluator.evaluate(r,...a);e.innerHTML="",e.textContent=o}tplValue(t,e,r,n,...a){e.value=t.evaluator.evaluate(r,...a)}tplHtml(t,e,r,n,...a){const o=t.evaluator.evaluate(r,...a);e.innerHTML=o}tplClassAppend(t,e,r,n,...a){const o=t.evaluator.evaluate(r,...a),l=Array.isArray(o)?o:[o];e.classList.add(...l)}tplAttrAppend(t,e,r,n,...a){const o=t.evaluator.evaluate(r,...a);if(0===o.length)return;(Array.isArray(o[0])?o:[o]).forEach((([t,r])=>{e.setAttribute(t,r)}))}textNode(t,e,r,n,...a){const o=t.textNodeEvaluator.evaluate(r,...a).map((t=>"t"===t.t?document.createTextNode(t.v):i.fragmentFromHtml(t.v)));n.replace(e,o)}}class f{fragment;evaluator;textNodeEvaluator;commandsHandler;static fromHtml(t,e){return new f(i.fragmentFromHtml(t),e)}static fromNodes(t,e){return new f(i.fragmentFromNodes(!0,!1,...t),e)}static fromNode(t,e){return new f(i.fragmentFromNodes(!0,!0,t),e)}static fromSelector(t,e){const r=document.querySelector(t);return new f(i.fragmentFromNodes(!0,!0,r),e)}static render(t,e,...r){return new f(t,e).render(...r)}static renderTo(t,e,r,...n){return new f(t,e).renderTo(r,...n)}static renderToSelector(t,e,r,...n){return new f(t,e).renderToSelector(r,...n)}static appendTo(t,e,r,...n){return new f(t,e).appendTo(r,...n)}static appendToSelector(t,e,r,...n){return new f(t,e).appendToSelector(r,...n)}constructor(t,{evaluator:e,textNodeEvaluator:r,commandsHandler:n}){this.fragment=t,this.evaluator=e,this.textNodeEvaluator=r,this.commandsHandler=n||new h}withNode(t){const e=this.evaluator,r=this.textNodeEvaluator,n=this.commandsHandler;return f.fromNode(t,{evaluator:e,textNodeEvaluator:r,commandsHandler:n})}render(...t){const e=this.commandsHandler.dataPrefix(),r=new s(e),n=this.fragment.cloneNode(!0),a=function(t,e,r){const n=`data-${t}-`;return function(t){return t.nodeType===Node.TEXT_NODE?-1!==t.nodeValue.indexOf(e)&&-1!==t.nodeValue.indexOf(r)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT:Array.from(t.attributes).some((t=>t.name.startsWith(n)))?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}}(e,"{{","}}"),o=document.createNodeIterator(n,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT,a);let l;for(;null!==(l=o.nextNode());){if(r.cleanup(),l.nodeType===Node.TEXT_NODE){this.commandsHandler.textNode(this,l,l.nodeValue,r,...t);continue}const e=this.commandsHandler.orderedCommands();for(let n=0;n!==e.length;++n){const a=e[n];if(!(a in l.dataset))continue;const o=r.popData(l,a);this.commandsHandler[a](this,l,o,r,...t)}Object.keys(l.dataset).filter((t=>t.startsWith(this.commandsHandler.dataPrefix()))).map((t=>[t,t.substring(this.commandsHandler.dataPrefix().length).split(/(?=[A-Z])/).join("-").toLowerCase()])).forEach((([e,n])=>{const a=r.popData(l,e),o=this.evaluator.evaluate(a,...t);l.setAttribute(n,o)}))}return r.cleanup(),n}renderTo(t,...e){const r=this.render(...e);t.innerHTML="",t.appendChild(r)}renderToSelector(t,...e){const r=document.querySelector(t);this.renderTo(r,...e)}appendTo(t,...e){const r=this.render(...e);t.appendChild(r)}appendToSelector(t,...e){const r=document.querySelector(t);this.appendTo(r,...e)}}export{u as ExpressionEvaluator,f as Template,c as TextNodeExpressionEvaluator,h as TplCommandsHandler};
//# sourceMappingURL=ftl.min.mjs.map
