<head>
</head>

<body>
    <button>Test</button>
    <div id="target"></div>
    <script>
        const template = `
            <div>               
                <div> 1 </div> 
                <div>  2</div> 
                <div> 3 </div> 
                <div> 4 </div> 
                <div> 5 </div> 
                <div> 6 </div> 
                <div> 7 </div> 
                <div> 8 </div>  
                <div> 9 </div> 
                <div> 10 </div> 
            </div>
        `;

        const makeFragment = () => {
            const t = document.createElement("template");
            t.innerHTML = template;
            return document.adoptNode(t.content);
            //return t.content;
        }

        const makeTestFragment = () => {
            const f = makeFragment();
            const d = document.createDocumentFragment();
            for (let i = 0; i != 100; ++i) {
                const d1 = document.createDocumentFragment();
                d.append(f.cloneNode(true));
                d.appendChild(d1);
            }
            return d;
        }

        const timed = (str, cb) => {
            const b = new Date().getTime();
            console.log(str);
            try {
                return cb();
            } finally {
                const a = new Date().getTime();
                console.log(str, "done", a - b, "ms");
            }
        }
        const createNodeFilter = (dataPrefix, textNodeExpressionStart, textNodeExpressionEnd) => {
    const attributePrefix = `data-${dataPrefix}-`;
    return (node) => {
        if (node.nodeType === Node.TEXT_NODE) {
            return node.nodeValue.includes(textNodeExpressionStart) && node.nodeValue.includes(textNodeExpressionEnd)
                ? NodeFilter.FILTER_ACCEPT
                : NodeFilter.FILTER_REJECT;
        }
        return Array.from(node.attributes).some(attr => attr.name.startsWith(attributePrefix))
            ? NodeFilter.FILTER_ACCEPT
            : NodeFilter.FILTER_SKIP;
    };
}

        document.addEventListener('DOMContentLoaded', () => {

            document.querySelector('button').addEventListener('click', () => {
                const fragments = timed("setup", () => Array(5_000).fill(0).map(makeTestFragment));
                const ref = document.querySelector("#target");
                const result = new DocumentFragment();
                for(let f of fragments){
                    result.appendChild(f);
                }
                timed("insert", () => {
                    ref.replaceChildren(result);
                })
            })

        })
    </script>    
</body>